<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Search</title>
    <link rel="stylesheet" type="text/css" href="itemsearch.css">
</head>
<body>
    <div class="center-container">
        <h1>Item Search</h1>
        <label for="json-file-select">Select JSON File:</label>
        <select id="json-file-select" onchange="loadSelectedFile()">
            <option value="">Select a file...</option>
            <option value="achievements">Achievements</option>
            <option value="archivedQuests">Archived Quests</option>
            <option value="character">Character</option>
            <option value="customization">Customization</option>
            <option value="defaultEquipmentPresets">Default Equipment Presets</option>
            <option value="handbook">Handbook</option>
            <option value="items">Items</option>
            <option value="prices">Prices</option>
            <option value="profiles">Profiles</option>
            <option value="quests">Quests</option>
            <option value="repeatableQuests">Repeatable Quests</option>
        </select>

        <input type="text" id="dynamic-search" placeholder="Start typing to search..." oninput="performSearch()" style="display: none;">
        <div class="dropdown-menu" id="dropdown-content"></div>
    </div>

    <section id="item-display" class="center-content"></section>

    <script>
        let data = [];
        let searchKey = '';
        let languageData = {};

        async function loadSelectedFile() {
            const fileSelect = document.getElementById('json-file-select');
            const selectedFile = fileSelect.value;
            const searchInput = document.getElementById('dynamic-search');
            searchInput.style.display = selectedFile ? 'block' : 'none';
            searchInput.value = '';
            document.getElementById('dropdown-content').style.display = 'none';
            data = [];

            if (!selectedFile) return;

            try {
                const response = await fetch(`https://raw.githubusercontent.com/CathieNova/Haven-VCQL-Helper/refs/heads/main/database/templates/${selectedFile}.json`);
                if (!response.ok) throw new Error(`Error loading file: ${response.status}`);
                const fileData = await response.json();
                data = Object.values(fileData);
                
                if (selectedFile === 'items') {
                    data.forEach(item => {
                        item.displayName = item._props && item._props.Name ? item._props.Name : 'Unnamed Item';
                    });
                    searchKey = 'displayName';
                    mapLanguageToItems();
                } else {
                    searchKey = selectedFile === 'achievements' || selectedFile === 'quests' ? 'name' : 'title';
                }

                displayResults(data); 
                populateDropdown();
            } catch (error) {
                console.error(`Failed to load ${selectedFile}.json:`, error);
            }
        }

        function mapLanguageToItems() {
            if (!languageData || !data.length) return;
            data.forEach(item => {
                const itemId = item._id;
                const shortNameKey = `${itemId} ShortName`;
                const nameKey = `${itemId} Name`;
                item.displayName = languageData[nameKey] || languageData[shortNameKey] || item._props.Name;
            });
        }

        function performSearch() {
            const searchTerm = document.getElementById('dynamic-search').value.toLowerCase();
            const filteredData = data.filter(item => (item[searchKey] || '').toLowerCase().includes(searchTerm));
            displayResults(filteredData);
        }

        function displayResults(results) {
            const itemDisplay = document.getElementById('item-display');
            itemDisplay.innerHTML = `<h2>Results:</h2><pre>${formatResults(results)}</pre>`;
        }

        function formatResults(results) {
            return results.map(result => JSON.stringify(result, null, 2)).join('\n\n');
        }

        function populateDropdown() {
            const dropdownMenu = document.querySelector('.dropdown-menu');
            dropdownMenu.innerHTML = data.map(item => `
                <div class="dropdown-item" data-value="${item._id}" onclick="selectDropdownItem(this)">
                    ${item.displayName || item._props.Name || 'Unnamed Item'}
                </div>
            `).join('');
            dropdownMenu.style.display = data.length ? 'block' : 'none';
        }

        function selectDropdownItem(element) {
            const selectedItemId = element.getAttribute('data-value');
            const selectedItem = data.find(item => item._id === selectedItemId);

            const itemDisplay = document.getElementById('item-display');
            itemDisplay.innerHTML = selectedItem ? `<pre>${formatItemDetails(selectedItem)}</pre>` : '<p>No item selected</p>';

            document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));
        }

        function formatItemDetails(item) {
            let detailsHtml = `<strong>ID:</strong> ${item._id}\n`;
            detailsHtml += `<strong>Type:</strong> ${item._type}\n`;
            detailsHtml += `<strong>Properties:</strong>\n${formatProperties(item._props, 1)}`;
            return detailsHtml;
        }

        function formatProperties(props, indentLevel) {
            const indent = ' '.repeat(indentLevel * 4);
            let result = '';

            for (const [key, value] of Object.entries(props)) {
                if (typeof value === 'object' && value !== null) {
                    result += `${indent}<strong>${key}</strong>: ${formatNestedProperties(value, indentLevel + 1)}\n`;
                } else {
                    result += `${indent}<strong>${key}</strong>: ${formatWithItemName(value)}\n`;
                }
            }

            return result;
        }

        function formatNestedProperties(obj, indentLevel) {
            const indent = ' '.repeat(indentLevel * 4);
            if (Array.isArray(obj)) {
                if (obj.length === 0) return '[]';
                return `[\n${obj.map(item => `${indent}${formatNestedProperties(item, indentLevel + 1)}`).join(',\n')}\n${' '.repeat((indentLevel - 1) * 4)}]`;
            } else if (typeof obj === 'object') {
                return `{\n${Object.entries(obj).map(([key, value]) => 
                    `${indent}<strong>${key}</strong>: ${typeof value === 'object' ? formatNestedProperties(value, indentLevel + 1) : formatWithItemName(value)}`
                ).join('\n')}\n${' '.repeat((indentLevel - 1) * 4)}}`;
            } else {
                return formatWithItemName(obj);
            }
        }

        function formatWithItemName(value) {
            if (isMongoDBObjectId(value)) {
                const relatedItem = data.find(item => item._id === value);
                return relatedItem 
                    ? `${value} <span class="name-highlight">// ${relatedItem.displayName}</span>`
                    : value;
            }
            return value;
        }

        function isMongoDBObjectId(value) {
            return typeof value === 'string' && /^[a-f\d]{24}$/i.test(value);
        }

        document.addEventListener('click', (event) => {
            const isDropdownItem = event.target.classList.contains('dropdown-item');
            const isSearchInput = event.target.classList.contains('dropdown-search');

            if (!isDropdownItem && !isSearchInput) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));
            }
        });

        window.onload = async function() {
            await loadLanguage('en.json');
        };

        async function loadLanguage(languageFile) {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/CathieNova/Haven-VCQL-Helper/refs/heads/main/lang/${languageFile}`);
                if (!response.ok) throw new Error(`Error loading language file: ${response.status}`);
                
                languageData = await response.json();
                console.log("Language data loaded");
            } catch (error) {
                console.error("Failed to load language data:", error);
            }
        }
    </script>
</body>
</html>
