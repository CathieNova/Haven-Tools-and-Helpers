<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Search</title>
    <link rel="stylesheet" type="text/css" href="itemsearch.css">
</head>
<body>
    <div class="center-container">
        <div class="item-search-container">
            <h1>Item Search</h1>
            <label for="json-file-select">Select JSON File:</label>
            <select id="json-file-select" onchange="loadSelectedFile()">
                <option value="">Select a file...</option>
                <option value="achievements">Achievements</option>
                <option value="handbook">Handbook</option>
                <option value="items">Items</option>
                <option value="quests">Quests</option>
                <option value="repeatableQuests">Repeatable Quests</option>
                <option value="itemGroups">Item Groups</option>
            </select>

            <input type="text" id="dynamic-search" placeholder="Start typing to search..." oninput="performSearch()" style="display: none;">
            <div class="dropdown-menu" id="dropdown-content"></div>

            <button id="show-all-button" onclick="showAll()" style="display: none;">Show All</button>
        </div>
        <section id="item-display" class="center-content"></section>
    </div>


    <script>
        let data = [];
        let searchKey = '';
        let languageData = {};

        async function loadSelectedFile() {
            const fileSelect = document.getElementById('json-file-select');
            const selectedFile = fileSelect.value;
            const searchInput = document.getElementById('dynamic-search');
            const showAllButton = document.getElementById('show-all-button');
            const itemDisplay = document.getElementById('item-display');

            searchInput.style.display = selectedFile ? 'block' : 'none';
            showAllButton.style.display = selectedFile ? 'block' : 'none';
            itemDisplay.style.display = 'none';
            searchInput.value = '';
            document.getElementById('dropdown-content').style.display = 'none';
            data = [];

            if (!selectedFile) return;

            try {
                const response = await fetch(`https://raw.githubusercontent.com/CathieNova/Haven-VCQL-Helper/refs/heads/main/database/templates/${selectedFile}.json`);
                if (!response.ok) throw new Error(`Error loading file: ${response.status}`);
                const fileData = await response.json();

                switch (selectedFile) {
                    case 'achievements':
                        data = Array.isArray(fileData) ? fileData : [];
                        searchKey = 'id';
                        break;
                    case 'quests':
                    case 'archivedQuests':
                    case 'repeatableQuests':
                        data = Object.values(fileData).map(item => ({ displayName: item.QuestName || item._id, ...item }));
                        searchKey = 'QuestName';
                        break;
                    case 'handbook':
                        data = fileData.Categories || [];
                        searchKey = 'Id';
                        break;
                    case 'items':
                        data = Object.values(fileData).map(item => ({
                            displayName: item._props?.Name || 'Unnamed Item',
                            ...item
                        }));
                        searchKey = 'displayName';
                        mapLanguageToItems();
                        break;
                    case 'itemGroups':
                        data = Object.entries(fileData).map(([id, item]) => ({
                            displayName: idToNameMap[id] || id,
                            ...item
                        }));
                        searchKey = 'displayName';
                        break;
                    default:
                        data = [];
                        searchKey = 'name';
                        break;
                }

                populateDropdown(data);
            } catch (error) {
                console.error(`Failed to load ${selectedFile}.json:`, error);
            }
        }

        function mapLanguageToItems() {
            if (!languageData || !data.length) return;
            data.forEach(item => {
                const itemId = item._id;
                const shortNameKey = `${itemId} ShortName`;
                const nameKey = `${itemId} Name`;
                item.displayName = languageData[nameKey] || languageData[shortNameKey] || item._props.Name;
            });
        }

        function performSearch() {
            const searchTerm = document.getElementById('dynamic-search').value.toLowerCase();
            const filteredData = data.filter(item => (item[searchKey] || '').toLowerCase().includes(searchTerm));
            populateDropdown(filteredData || []);
        }

        function displayResults(results) {
            const itemDisplay = document.getElementById('item-display');
            itemDisplay.style.display = 'block';
            itemDisplay.innerHTML = `<pre>${formatItemDetails(results)}</pre>`;
        }

        function showAll() {
            displayResults(data);
        }

        function populateDropdown(results) {
    const dropdownMenu = document.getElementById('dropdown-content');
    
    results.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''));

    dropdownMenu.innerHTML = results.map(item => {
        const displayText = item.displayName || item.QuestName || item.Name || item._props?.Name || item._id || item.id || item.Id;
        return `
            <div class="dropdown-item" data-value="${item._id || item.id || item.Id}" onclick="selectDropdownItem(this)">
                ${displayText}
            </div>
        `;
    }).join('');

    dropdownMenu.style.display = results.length ? 'block' : 'none';
}


        function selectDropdownItem(element) {
            const selectedItemId = element.getAttribute('data-value');
            const selectedItem = data.find(item => item._id === selectedItemId || item.id === selectedItemId || item.Id === selectedItemId);

            const itemDisplay = document.getElementById('item-display');
            const itemSelectedOutput = formatItemDetails(selectedItem);
            itemDisplay.style.display = 'block';
            itemDisplay.innerHTML = selectedItem ? `<pre>${itemSelectedOutput}</pre>` : '<p>No item selected</p>';

            document.getElementById('dropdown-content').style.display = 'none';
        }

        function formatItemDetails(item) {
            let json = JSON.stringify(item, null, 4);

            // Colorize keys
            json = json.replace(/"([\w]+)":/g, '<span class="json-key">"$1"</span>:');

            // Colorize strings (values in quotes)
            json = json.replace(/: "(.*?)"/g, ': <span class="json-string">"$1"</span>');

            // Colorize numbers
            json = json.replace(/: (\d+)(,?)/g, ': <span class="json-number">$1</span>$2');

            // Colorize booleans
            json = json.replace(/: (true|false)(,?)/g, ': <span class="json-boolean">$1</span>$2');

            // Colorize MongoDB Object IDs (24-character hex strings)
            json = json.replace(/"([a-f\d]{24})"/g, '<span class="mongo-id">"$1"</span>');

            return json;
        }

        document.addEventListener('click', (event) => {
            const isDropdownItem = event.target.classList.contains('dropdown-item');
            const isSearchInput = event.target.classList.contains('dropdown-search');

            if (!isDropdownItem && !isSearchInput) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));
            }
        });

        window.onload = async function() {
            await loadLanguage('en.json');
        };

        async function loadLanguage(languageFile) {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/CathieNova/Haven-VCQL-Helper/refs/heads/main/lang/${languageFile}`);
                if (!response.ok) throw new Error(`Error loading language file: ${response.status}`);
                
                languageData = await response.json();
                console.log("Language data loaded");
            } catch (error) {
                console.error("Failed to load language data:", error);
            }
        }
    </script>
</body>
</html>
