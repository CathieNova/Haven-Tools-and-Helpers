<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haven VCQL Helper</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
    <h1>Haven Quest Helper</h1>
    <h4>Made for Virtual's Custom Quest Loader - SPT Mod</h4>
    <h4>This website will update often since it's work in progress so make sure to refresh it to see changes. (current version: 0.0.1)</h6>
    
    <div id="top-right-box" style="position: absolute; top: 20px; right: 20px; border: 1px solid #ccc; padding: 10px;  border-radius: 8px;">
        <h3><strong>Website Settings</strong></h3>
        <div id="language-container" style="text-align: left;">
            <label for="language-select">Item Names Language: </label>
            <select id="language-select" onchange="loadLanguage(this.value)">
                <option value="en.json" selected>English</option>
                <option value="cz.json">Czech</option>
                <option value="fr.json">French</option>
                <option value="ge.json">German</option>
                <option value="hu.json">Hungarian</option>
                <option value="it.json">Italian</option>
                <option value="jp.json">Japanese</option>
                <option value="kr.json">Korean</option>
                <option value="pl.json">Polish</option>
                <option value="po.json">Portuguese</option>
                <option value="ro.json">Romanian</option>
                <option value="ru.json">Russian</option>
                <option value="sk.json">Slovak</option>
                <option value="ch.json">Chinese</option>
                <option value="es.json">Spanish</option>
                <option value="es-mx.json">Mexican Spanish</option>
                <option value="tu.json">Turkish</option>
            </select>
        </div>
        
        <button id="toggleUsefulInfoBtn" onclick="toggleUsefulInfo()" style="margin-top: 10px; width: 100%;">Show Useful Info</button>
        <button id="toggleHowToUseBtn" onclick="toggleHowToUse()" style="margin-top: 10px; width: 100%;">Show How to Use</button>
        <button id="reloadButton" onclick="reloadPage()" style="margin-top: 10px;">Reset Quest Info</button>
    </div>

    <section id="useful-info" style="display: none; position: relative;">
        <strong>Useful info:</strong>
        <ul>
            <li><a href="https://hub.sp-tarkov.com/doc/entry/7-resources-item-properties-list/" target="_blank" style="color: #4646ff; text-decoration: underline;">Item Resource List</a></li>
            <li><a href="https://hub.sp-tarkov.com/doc/entry/57-resources-quest-values-reference-tool/" target="_blank" style="color: #4646ff; text-decoration: underline;">Quest Values Reference Tool</a></li>
            <li><a href="https://raw.githubusercontent.com/RuKira/SPT-AllInOne/refs/heads/main/SPT-AllInOne/Data/quests.json" target="_blank" style="color: #4646ff; text-decoration: underline;">EFT Default Quest References</a></li>
        </ul>
        <strong>Zone ID List for Kills condition</strong>
        <ul>
            <li><a href="https://github.com/guillaumearm/SPT_CustomQuests/blob/master/docs/ALL_ZONES.md" target="_blank" style="color: #4646ff; text-decoration: underline;">Zones IDs</a></li>
            <li><a href="https://github.com/guillaumearm/SPT_CustomQuests/blob/master/docs/ALL_PLACES.md" target="_blank" style="color: #4646ff; text-decoration: underline;">Places IDs</a></li>
        </ul>
        <h4>Version 0.0.1</h4>
    </section>
    
    <section id="how-to-use" style="display: none; position: relative;">
        <strong>How to use:</strong>
        <ul>
            <li>Quest Name is the name of the quest (it converts it into an id for you too)</li>
            <li>Trader Name is the name of the trader that gives the quest</li>
            <li>Objective Conditions are the requirements for the quest like finding items, killing scavs, etc.</li>
                <ul>
                    <li>Find Item: Find an item in raid
                        <ul>
                            <li>You can add or remove multiple items to find.</li>
                            <li>Target Items: The item(s) that need to be found</li>
                            <li>Value: The quantity of the item(s) that need to be found</li>
                            <li>Only Found In Raid: Whether the item(s) need to be found in raid</li>
                        </ul>
                    </li>
                    <li>Handover Item: Handover an item
                        <ul>
                            <li>This is the same as Find Item but instead it's handing them over to the trader.</li>
                        </ul>
                    </li>
                    <li>Kills: Kill a certain amount of scavs or PMCs
                        <ul>
                            <li>Zone ID: The zone ID where the kills need to be done</li>
                            <li>Location: The location where the kills need to be done</li>
                            <li>Target: The type of target to kill (Scavs, PMCs, etc.)</li>
                            <li>Kills Required: The number of kills required</li>
                            <li>Distance Comparison: The distance for the kills for example less than 50 meters.
                                <ul>
                                    <li>Right > means greater than or equal to</li>
                                    <li>Left < means less than or equal to</li>
                                </ul>
                            </li>
                            <li>Time of Day From: for example 6am would be 6</li>
                            <li>Time of Day To: for example 6pm would be 18</li>
                            <li>Reset on Session End: Whether the kills reset on session end</li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
    </section>
    
    <!-- Quest Input Section -->
    <h2>Quest Creation</h2>
    <section>
        <label for="quest-name">Quest Name:</label>
        <input type="text" id="quest-name" placeholder="Enter quest name" required>

        <label for="trader-name">Quest Trader Name:</label>
        <input type="text" id="trader-name" placeholder="Enter Trader name" required>

        <label for="quest-number">Quest Number</label>
        <input type="number" id="quest-number" placeholder="Enter Quest Number" required value="0">


        <label for="quest-type">Quest Type:</label>
        <select id="quest-type">
            <option value="PickUp">Pick Up</option>
            <option value="Completion">Completion</option>
            <option value="Discover">Discover</option>
            <option value="Exploration">Exploration</option>
            <option value="Loyalty">Loyalty</option>
            <option value="WeaponAssembly">Weapon Assembly</option>
            <option value="Standing">Standing</option>
            <option value="Skill">Skill</option>
            <option value="Merchant">Merchant</option>
            <option value="Elimination">Elimination</option>
            <option value="Multi">Multi</option>
        </select>

        <h3>Available For Start Conditions (if applicable)</h3>
        <button onclick="addAvailableForStartCondition()">Add Condition</button>
        <div id="available-for-start-container" class="dynamic-fields"></div>

        <h3>Objective Conditions</h3>
        <button onclick="addCondition()" style="margin-bottom: 10px;">Add Condition</button>
        <div id="conditions-container" class="dynamic-fields"></div>

        <h3>Rewards</h3>
        <button onclick="addReward()" style="margin-bottom: 10px;">Add Reward</button>
        <div id="rewards-container" class="dynamic-fields"></div>

        <h3>Quest Language Variables</h3>
        <div id="language-variables-container" style="margin-bottom: 20px;">
            <div id="language-entries-section"></div>
            <div id="dynamic-lang-variables-container"></div>
        </div>

        <!-- Language Variables for Conditions and Rewards -->
        <h3>Condition & Reward Language Variables</h3>
        <div id="dynamic-lang-variables-container"></div>

        <button onclick="generateQuest()" style="margin-top: 10px;">Generate Quest JSON</button>
    </section>
    
    <section id="quest-output-section" style="display: none; position: relative;">
        <h2>Quest JSON Output</h2>
        
        <div style="position: relative;">
            <button id="copyQuestButton" onclick="copyQuest()" style="position: absolute; right: 10px; top: 30px; padding: 5px 10px; width: auto;">
                Copy Quest to Clipboard
            </button>
        </div>
        <pre id="output" style="margin-top: 40px; padding: 10px;">Generated quest JSON will appear here...</pre>
    
        <div style="margin-top: 40px; padding: 15px; border: 1px solid #444; border-radius: 5px; background-color: #1e1e1e; color: #e0e0e0; position: relative;">
            <h3>Quest Language Variables</h3>
            <button id="copyLangButton" onclick="copyLanguageEntries()" style="position: absolute; right: 10px; top: 10px; padding: 5px 10px; width: auto;">
                Copy Language Variables to Clipboard
            </button>
            <pre id="language-output" style="margin-top: 20px; padding: 10px;">Language variables will appear here...</pre>
        </div>
        <div style="margin-top: 40px; padding: 15px; border: 1px solid #444; border-radius: 5px; background-color: #1e1e1e; color: #e0e0e0; position: relative;">
            <h3>Quest Assortments</h3>
            <button id="copyAssortmentsButton" onclick="copyAssortments()" style="position: absolute; right: 10px; top: 10px; padding: 5px 10px; width: auto;">
                Copy Assortments to Clipboard
            </button>
            <pre id="assortments-output" style="margin-top: 20px; padding: 10px;">Assortments will appear here...</pre>
        </div>
    </section>

    <script>
        let items = [];
        let languageData = {};

        document.addEventListener('DOMContentLoaded', () => {
            loadLanguage('en.json');
            loadItems();
            populateLanguageFields();
        });

        function reloadPage() {
            const currentUrl = window.location.href.split('?')[0];
            window.location.href = `${currentUrl}?t=${new Date().getTime()}`;
        }

        async function loadLanguage(languageFile) {
            try {
                const response = await fetch(`lang/${languageFile}`);
                if (!response.ok) throw new Error(`Error loading language file: ${response.status}`);
                
                languageData = await response.json();
                
                mapLanguageToItems();
                
                const targetItemDivs = document.querySelectorAll('.target-item .dropdown-item');
                targetItemDivs.forEach(itemDiv => {
                    const itemId = itemDiv.getAttribute('data-value');
                    const item = items.find(i => i._id === itemId);
                    if (item) {
                        itemDiv.textContent = item.displayName;
                    }
                });
            } catch (error) {
                console.error("Failed to load language:", error);
            }
        }

        async function loadItems() {
            if (!window.itemsLoaded) {
                try {
                    const response = await fetch('items.json');
                    if (!response.ok) throw new Error(`Error loading items: ${response.status}`);
                    const allItems = await response.json();

                    items = Object.values(allItems).filter(item => item._id && item._props);

                    mapLanguageToItems();
                    items.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''));

                    window.itemsLoaded = true;
                } catch (error) {
                    console.error("Failed to load items:", error);
                    window.itemsLoaded = false;
                }
            }
        }

        function mapLanguageToItems() {
            if (!languageData || !items) return;

            items.forEach(item => {
                const itemId = item._id;
                const shortNameKey = `${itemId} ShortName`;
                const nameKey = `${itemId} Name`;

                item.displayName = languageData[nameKey] || languageData[shortNameKey] || item._props.Name;
            });

            items.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''));
        }

        function addCondition() {
            const container = document.getElementById('conditions-container');
            const conditionDiv = document.createElement('div');
            conditionDiv.classList.add("condition");

            const conditionIndex = container.childElementCount + 1;
            const traderId = document.getElementById('trader-name').value || 'trader';
            const questNumber = document.getElementById('quest-number').value || '0';
            const objLabel = `${traderId}_${questNumber} obj_${conditionIndex}`;

            conditionDiv.innerHTML = `
                <label>Condition Type:
                    <select onchange="updateConditionFields(this)">
                        <option value="FindItem">Find Item</option>
                        <option value="HandoverItem">Handover Item</option>
                        <option value="Kills">Kills</option>
                    </select>
                </label>
                <div class="condition-details"></div>
                <div class="target-items-container"></div>
            `;
            container.appendChild(conditionDiv);

            updateConditionFields(conditionDiv.querySelector('select'));

            // Directly add the language field for this specific objective
            addLanguageField(objLabel, `Objective ${conditionIndex}`);
        }

        function addLanguageField(fieldId, label) {
            const languageSection = document.getElementById('dynamic-lang-variables-container');
            
            const div = document.createElement('div');
            div.className = 'dynamic-lang-entry';
            div.innerHTML = `<label for="${fieldId}">${label}:</label><input type="text" id="${fieldId}" placeholder="Enter text for ${label}">`;
            languageSection.appendChild(div);
        }

        function removeCondition(button) {
            const conditionDiv = button.closest('.condition');
            const conditionIndex = Array.from(conditionDiv.parentNode.children).indexOf(conditionDiv) + 1;
            const traderId = document.getElementById('trader-name').value || 'trader';
            const questNumber = document.getElementById('quest-number').value || '0';
            const objLabel = `${traderId}_${questNumber} obj_${conditionIndex}`;

            // Remove the associated language entry
            document.getElementById(objLabel)?.parentElement.remove();

            // Remove the condition
            conditionDiv.remove();

            // Adjust language fields if needed
            adjustLanguageFields();
        }
        
        function adjustLanguageFields() {
            const traderId = document.getElementById('trader-name').value || 'trader';
            const questNumber = document.getElementById('quest-number').value || '0';
            const conditions = document.querySelectorAll('#conditions-container > .condition');
            const languageSection = document.getElementById('dynamic-lang-variables-container');
            let index = 1;

            conditions.forEach(condition => {
                const fieldId = `${traderId}_${questNumber} obj_${index}`;
                const existingInput = document.getElementById(fieldId);

                if (!existingInput) {
                    addLanguageField(fieldId, `Objective ${index}`);
                }

                index++;
            });
        }

        async function updateConditionFields(selectElement) {
            if (!window.itemsLoaded) {
                await loadItems();
                if (!window.itemsLoaded) return;
            }

            const conditionDetails = selectElement.closest('.condition').querySelector('.condition-details');
            if (!conditionDetails) return; // Check if conditionDetails is found

            // Populate conditionDetails based on selection value
            if (selectElement.value === 'FindItem' || selectElement.value === 'HandoverItem') {
                conditionDetails.innerHTML = `
                    <label>Target Items:</label>
                    <div class="target-items-container"></div>
                    <button type="button" onclick="addTargetItem()" style="margin-top: 10px; width: auto;">Add New Item</button>
                    <label>Value:
                        <input type="number" placeholder="Enter level" required value="1">
                    </label>
                    <label>Only Found In Raid:
                        <input type="checkbox">
                    </label>
                    <div style="margin-top: 10px; display: inline-block;">
                        <button class="remove-btn" onclick="removeCondition(this)" style="width: auto; padding: 5px 10px;">Remove Condition</button>
                    </div>
                `;
            } else if (selectElement.value === 'Kills') {
                conditionDetails.innerHTML = `
                    <label>Zone ID (e.g., huntsman_005_2) 
                        <a href="https://github.com/guillaumearm/SPT_CustomQuests/blob/master/docs/ALL_ZONES.md" target="_blank" style="color: #4646ff; text-decoration: underline;">Click Here for All Zones</a>:
                        <input type="text" placeholder="Enter zone ID" required>
                    </label>
                    <label>Location:
                        <select class="location-dropdown" required>
                            <option value="any" selected>Any</option>
                            <option value="55f2d3fd4bdc2d5f408b4567">Factory Day</option>
                            <option value="59fc81d786f774390775787e">Factory Night</option>
                            <option value="56f40101d2720b2a4d8b45d6">Customs</option>
                            <option value="5704e3c2d2720bac5b8b4567">Woods</option>
                            <option value="5704e4dad2720bb55b8b4567">Lighthouse</option>
                            <option value="5704e554d2720bac5b8b456e">Shoreline</option>
                            <option value="5704e5fad2720bc05b8b4567">Reserve</option>
                            <option value="5714dbc024597771384a510d">Interchange</option>
                            <option value="5b0fc42d86f7744a585f9105">The Lab</option>
                            <option value="5714dc692459777137212e12">Streets</option>
                            <option value="653e6760052c01c1c805532f">Ground Zero</option>
                        </select>
                    </label>
                    <label>Target:
                        <select required>
                            <option value="Savage">Scavs</option>
                            <option value="AnyPmc">PMCs</option>
                            <option value="Usec">Usec</option>
                            <option value="Bear">Bear</option>
                            <option value="Any" selected>Any</option>
                        </select>
                    </label>
                    <label>Kills Required:
                        <input type="number" placeholder="Number of kills" required value="1">
                    </label>
                    <label>Distance Comparison:
                        <select>
                            <option value=">=">&ge;</option>
                            <option value="<=">&le;</option>
                        </select>
                        <input type="number" placeholder="Distance in meters" required value="0">
                    </label>
                    <label>Time of Day From (0-24):
                        <input type="number" min="0" max="24" value="0" required>
                    </label>
                    <label>Time of Day To (0-24):
                        <input type="number" min="0" max="24" value="0" required>
                    </label>
                    <label>Reset on Session End:
                        <input type="checkbox">
                    </label>
                    <div style="margin-top: 10px; display: inline-block;">
                        <button class="remove-btn" onclick="removeCondition(this)" style="width: auto; padding: 5px 10px;">Remove Condition</button>
                    </div>
                `;
            }
        }

        function addTargetItem() {
            const conditionDiv = event.target.closest('.condition');
            const container = conditionDiv.querySelector('.target-items-container');
            const targetDiv = document.createElement('div');
            targetDiv.classList.add('target-item');

            targetDiv.innerHTML = `
                <label>Search or Enter ID:</label>
                <div class="custom-dropdown">
                    <input type="text" class="dropdown-search" placeholder="Search items..." oninput="filterDropdown(this)">
                    <div class="dropdown-menu">
                        ${items.map(item => `
                            <div class="dropdown-item" data-value="${item._id}" onclick="selectDropdownItem(this)">
                                ${item.displayName}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <label>Manual ID (optional):
                    <input type="text" class="manual-id" placeholder="Enter MongoDB ID (optional)">
                </label>
                <button type="button" onclick="removeTargetItem(this)" style="margin-top: 10px;">Remove</button>
            `;

            container.appendChild(targetDiv);
        }

        function removeTargetItem(button) {
            button.closest('.target-item').remove();
        }

        function filterDropdown(input) {
            const searchTerm = input.value.toLowerCase();
            const dropdownMenu = input.nextElementSibling;

            if (searchTerm) {
                dropdownMenu.classList.add('show');
            } else {
                dropdownMenu.classList.remove('show');
            }

            Array.from(dropdownMenu.children).forEach(item => {
                const itemName = item.textContent.toLowerCase();
                item.style.display = itemName.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function selectDropdownItem(item) {
            const dropdown = item.closest('.custom-dropdown');
            const selectedItem = dropdown.querySelector('.dropdown-search');
            selectedItem.value = item.textContent.trim();
            selectedItem.dataset.selectedValue = item.dataset.value;
            dropdown.querySelector('.dropdown-menu').classList.remove('show');
        }

        function addReward() {
            const container = document.getElementById('rewards-container');
            const rewardDiv = document.createElement('div');
            rewardDiv.classList.add("reward");

            rewardDiv.innerHTML = `
                <label>Reward Type:
                    <select onchange="updateRewardFields(this)">
                        <option value="Experience">Experience</option>
                        <option value="TraderStanding">Trader Standing</option>
                        <option value="Item">Item</option>
                        <option value="AssortmentUnlock">AssortmentUnlock</option>
                    </select>
                </label>
                <div class="reward-details"></div>
                <button onclick="removeReward(this)" style="margin-top: 10px; width: auto;">Remove Reward</button>
            `;
            
            container.appendChild(rewardDiv);
            updateRewardFields(rewardDiv.querySelector('select'));
        }

        function updateRewardFields(selectElement) {
            const rewardDetails = selectElement.closest('.reward').querySelector('.reward-details');
            rewardDetails.innerHTML = '';

            if (selectElement.value === 'AssortmentUnlock') {
                rewardDetails.innerHTML = `
                    <label>Reward ID:
                        <input type="text" class="assortment-id" placeholder="Enter reward _id" required>
                    </label>
                    <label>Loyalty Level:
                        <select class="loyalty-level" required>
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </label>
                    <label>Item:
                        <div class="custom-dropdown">
                            <input type="text" class="dropdown-search assortment-item" placeholder="Search items..." oninput="filterDropdown(this)">
                            <div class="dropdown-menu">
                                ${items.map(item =>
                                    `<div class="dropdown-item" data-value="${item._id}" onclick="selectRewardItem(this)">
                                        ${item.displayName}
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    </label>
                `;
            } else if (selectElement.value === 'Item') {
                rewardDetails.innerHTML = `
                    <label>Reward Item:</label>
                    <div class="custom-dropdown">
                        <input type="text" class="dropdown-search" placeholder="Search items..." oninput="filterDropdown(this)">
                        <div class="dropdown-menu">
                            ${items.map(item =>
                                `<div class="dropdown-item" data-value="${item._id}" onclick="selectRewardItem(this)">
                                    ${item.displayName}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    <label>Value:
                        <input type="number" placeholder="Quantity" required>
                    </label>
                `;
            } else if (selectElement.value === 'Experience' || selectElement.value === 'TraderStanding') {
                rewardDetails.innerHTML = `
                    <label>Values (comma-separated, e.g., 0.1, 1, 2.5):
                        <input type="text" class="reward-value" placeholder="Enter values, separated by commas">
                    </label>
                `;
            }
        }

        function selectRewardItem(item) {
            const dropdown = item.closest('.custom-dropdown');
            const selectedItem = dropdown.querySelector('.dropdown-search');
            selectedItem.value = item.textContent.trim();
            selectedItem.dataset.selectedValue = item.dataset.value;
            dropdown.querySelector('.dropdown-menu').classList.remove('show');
        }

        function removeReward(button) {
            button.closest('.reward').remove();
        }

        function copyQuest() {
            const outputText = document.getElementById('output').textContent;
            navigator.clipboard.writeText(outputText).then(() => {
                const button = document.getElementById('copyQuestButton');
                button.innerText = "Copied to Clipboard";
                setTimeout(() => button.innerText = "Copy Quest to Clipboard", 3000);
            }).catch(err => {
                console.error("Failed to copy quest:", err);
            });
        }

        function copyLanguageEntries() {
            const languageOutputText = document.getElementById('language-output').textContent; 
            if (!languageOutputText) {
                console.error("No language variables to copy.");
                return; 
            }
            navigator.clipboard.writeText(languageOutputText).then(() => {
                const button = document.getElementById('copyLangButton');
                button.innerText = "Copied to Clipboard";
                setTimeout(() => button.innerText = "Copy Language Variables to Clipboard", 3000);
            }).catch(err => {
                console.error("Failed to copy language variables:", err);
            });
        }


        let usefulInfoVisible = false;

        function toggleUsefulInfo() {
            const usefulInfoSection = document.getElementById('useful-info');
            usefulInfoVisible = !usefulInfoVisible;

            if (usefulInfoVisible) {
                usefulInfoSection.style.display = 'block';
                document.getElementById('toggleUsefulInfoBtn').innerText = 'Hide Useful Info';
            } else {
                usefulInfoSection.style.display = 'none';
                document.getElementById('toggleUsefulInfoBtn').innerText = 'Show Useful Info';
            }
        }

        let howToUseVisible = false;

        function toggleHowToUse() {
            const howToUseSection = document.getElementById('how-to-use');
            howToUseVisible = !howToUseVisible;

            if (howToUseVisible) {
                howToUseSection.style.display = 'block';
                document.getElementById('toggleHowToUseBtn').innerText = 'Hide How to Use';
            } else {
                howToUseSection.style.display = 'none';
                document.getElementById('toggleHowToUseBtn').innerText = 'Show How to Use';
            }
        }

        function populateLanguageFields() {
            const languageSection = document.getElementById('language-entries-section');
            if (!languageSection) {
                console.error("languageSection element is null.");
                return;
            }
            languageSection.innerHTML = ''; // Clear any previous entries

            // Quest name and basic language fields
            const baseFields = [
                { id: 'quest-desc-lang', label: 'Description' },
                { id: 'quest-start-msg-lang', label: 'Started Message' },
                { id: 'quest-success-msg-lang', label: 'Success Message' },
                { id: 'quest-fail-msg-lang', label: 'Fail Message' },
                { id: 'quest-accept-msg-lang', label: 'Accept Message' },
                { id: 'quest-decline-msg-lang', label: 'Decline Message' },
                { id: 'quest-complete-msg-lang', label: 'Complete Message' },
                { id: 'quest-change-msg-lang', label: 'Change Quest Message' }
            ];

            baseFields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'dynamic-lang-entry';
                div.innerHTML = `<label for="${field.id}">${field.label}:</label><input type="text" id="${field.id}" placeholder="Enter ${field.label.toLowerCase()}">`;
                languageSection.appendChild(div);
            });

            // Dynamic fields for all conditions with unique IDs
            const traderId = document.getElementById('trader-name').value || 'trader';
            const questNumber = document.getElementById('quest-number').value || '0';
            const conditions = document.querySelectorAll('#conditions-container > .condition');

            conditions.forEach((condition, index) => {
                const conditionType = condition.querySelector('select').value;
                const objLabel = `${traderId}_${questNumber} Obj_${index + 1}`;

                const div = document.createElement('div');
                div.className = 'dynamic-lang-entry';
                div.innerHTML = `<label for="${objLabel}">${objLabel} (${conditionType}):</label><input type="text" id="${objLabel}" placeholder="Enter text for ${conditionType} condition">`;
                languageSection.appendChild(div);
            });

            // Dynamic fields for rewards
            const rewards = document.querySelectorAll('#rewards-container > .reward');
            rewards.forEach((reward, index) => {
                const rewardId = `${traderId}_${questNumber} reward_${index}`;
                const div = document.createElement('div');
                div.className = 'dynamic-lang-entry';
                div.innerHTML = `<label for="${rewardId}">Reward ${index}:</label><input type="text" id="${rewardId}" placeholder="Enter reward text">`;
                languageSection.appendChild(div);
            });
        }

        function addAvailableForStartCondition() {
            const container = document.getElementById('available-for-start-container');
            const conditionDiv = document.createElement('div');
            conditionDiv.classList.add("condition");

            conditionDiv.innerHTML = `
                <label>Condition Type:
                    <select onchange="updateAvailableForStartFields(this)">
                        <option value="Level">Level</option>
                        <option value="Quest">Quest</option>
                        <option value="TraderLoyalty">Trader Loyalty</option>
                    </select>
                </label>
                <div class="available-for-start-details"></div>
                <button type="button" onclick="removeAvailableForStartCondition(this)" style="margin-top: 10px;">Remove</button>
            `;
            container.appendChild(conditionDiv);

            // Show the container if it has child elements
            container.style.display = 'block';
            updateAvailableForStartFields(conditionDiv.querySelector('select'));
        }

        function removeAvailableForStartCondition(button) {
            const container = document.getElementById('available-for-start-container');
            const conditionDiv = button.closest('.condition');
            conditionDiv.remove();

            // Hide the container if no child elements are present
            if (container.children.length === 0) {
                container.style.display = 'none';
            }
        }


        // Function to update fields based on selected condition type for AvailableForStart
        function updateAvailableForStartFields(selectElement) {
            const conditionDetails = selectElement.closest('.condition').querySelector('.available-for-start-details');
            conditionDetails.innerHTML = '';

            if (selectElement.value === 'Level') {
                conditionDetails.innerHTML = `
                    <label>Compare Method:
                        <select>
                            <option value=">=">>=</option>
                            <option value="<="><=</option>
                        </select>
                    </label>
                    <label>Value:
                        <input type="number" placeholder="Enter level" required>
                    </label>
                `;
            } else if (selectElement.value === 'Quest') {
                conditionDetails.innerHTML = `
                    <label>Quest Status:
                        <select>
                            <option value="1">Quest Available - 1</option>
                            <option value="2">Quest Accepted And In Progress - 2</option>
                            <option value="3">Quest Finished, Awaiting Confirmation - 3</option>
                            <option value="4" selected>Quest Finished And Confirmed - 4</option>
                            <option value="5">Quest Failed - 5</option>
                        </select>
                    </label>
                    <label>Target Quest ID:
                        <input type="text" placeholder="Enter quest ID" required>
                    </label>
                `;
            } else if (selectElement.value === 'TraderLoyalty') {
                conditionDetails.innerHTML = `
                    <label>Trader ID:
                        <input type="text" placeholder="Enter trader ID" required>
                    </label>
                    <label>Loyalty Level:
                        <select>
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </label>
                `;
            }
        }

        function copyAssortments() {
            const assortmentsText = document.getElementById('assortments-output').textContent;
            navigator.clipboard.writeText(assortmentsText).then(() => {
                const button = document.getElementById('copyAssortmentsButton');
                button.innerText = "Copied to Clipboard";
                setTimeout(() => button.innerText = "Copy Assortments to Clipboard", 3000);
            }).catch(err => {
                console.error("Failed to copy assortments:", err);
            });
        }


        function generateQuest() {
            const questName = document.getElementById('quest-name').value;
            const questNameID = questName.replace(/\s+/g, '_');
            const trader = document.getElementById('trader-name').value || 'TRADERNAME';
            const questNumber = document.getElementById('quest-number').value || '0';
            const questType = document.getElementById('quest-type').value;

            // Start Conditions
            const availableForStartConditions = Array.from(document.querySelectorAll('#available-for-start-container > .condition')).map((div, index) => {
                const conditionType = div.querySelector('select').value;
                
                if (conditionType === 'Level') {
                    const compareSelect = div.querySelector('select:nth-of-type(2)');
                    const levelInput = div.querySelector('input[type=number]');
                    
                    return {
                        compareMethod: compareSelect ? compareSelect.value : '',
                        conditionType: 'Level',
                        id: `level_condition_${index}`,
                        value: levelInput ? parseInt(levelInput.value, 10) : 0
                    };
                } else if (conditionType === 'Quest') {
                    const statusOptions = div.querySelectorAll('select[multiple] option:checked');
                    const targetInput = div.querySelector('input[type=text]');
                    
                    return {
                        conditionType: 'Quest',
                        id: `quest_condition_${index}`,
                        status: statusOptions.length > 0 ? Array.from(statusOptions).map(opt => parseInt(opt.value, 10)) : [],
                        target: targetInput ? targetInput.value : ''
                    };
                } else if (conditionType === 'TraderLoyalty') {
                    const targetInput = div.querySelector('input[type=text]');
                    const valueInput = div.querySelector('input[type=number]');
                    
                    return {
                        conditionType: 'TraderLoyalty',
                        id: `trader_loyalty_condition_${index}`,
                        target: targetInput ? targetInput.value : '',
                        value: valueInput ? parseInt(valueInput.value, 10) : 0
                    };
                }
                return {};
            });

            // Objective Conditions
            const conditions = Array.from(document.querySelectorAll('#conditions-container > .condition')).map((div, index) => {
                const conditionType = div.querySelector('select').value;
                const conditionId = `${trader}_${questNumber} obj_${index + 1}`;

                if (conditionType === 'FindItem' || conditionType === 'HandoverItem') {
                    const targetItems = Array.from(div.querySelectorAll('.target-item')).map(targetDiv => {
                        const manualId = targetDiv.querySelector('.manual-id')?.value;
                        return manualId || targetDiv.querySelector('.dropdown-search').dataset.selectedValue;
                    });
                    return {
                        conditionType: conditionType,
                        id: conditionId,
                        targetItems: targetItems,
                        value: parseInt(div.querySelector('input[type=number]').value, 10),
                        onlyFoundInRaid: div.querySelector('input[type=checkbox]').checked
                    };
                } else if (conditionType === 'Kills') {
                    return {
                        conditionType: "Kills",
                        id: conditionId,
                        zoneId: div.querySelector('input[type=text]').value,
                        location: div.querySelector('.location-dropdown').value,
                        target: div.querySelector('select:nth-of-type(2)').value,
                        killsRequired: parseInt(div.querySelector('input[type=number]').value, 10),
                        timeOfDay: {
                            from: parseInt(div.querySelector('input[type=number]:nth-of-type(1)').value, 10),
                            to: parseInt(div.querySelector('input[type=number]:nth-of-type(2)').value, 10)
                        }
                    };
                }
                return {};
            });

            // Rewards
            const rewards = Array.from(document.querySelectorAll('#rewards-container > .reward')).map((div, index) => {
                const rewardType = div.querySelector('select').value;
                const rewardId = `${trader}_${questNumber} reward_${index}`;

                if (rewardType === 'AssortmentUnlock' || rewardType === 'Item') {
                    const manualId = div.querySelector('.manual-id')?.value;
                    const selectedId = div.querySelector('.dropdown-search').dataset.selectedValue;
                    const itemId = manualId || selectedId;

                    return rewardType === 'Item' ? {
                        type: rewardType,
                        id: rewardId,
                        _tpl: itemId,
                        value: parseInt(div.querySelector('input[type=number]').value, 10)
                    } : {
                        type: 'AssortmentUnlock',
                        id: rewardId,
                        items: [{ _id: div.querySelector('.assortment-id').value, _tpl: itemId }],
                        loyaltyLevel: parseInt(div.querySelector('.loyalty-level').value, 10),
                        target: div.querySelector('.assortment-id').value
                    };
                } else if (rewardType === 'Experience' || rewardType === 'TraderStanding') {
                    return {
                        type: rewardType,
                        id: rewardId,
                        value: parseFloat(div.querySelector('input[type=number]').value.replace(',', '.'))
                    };
                }
                return {};
            });

            // Language Entries
            let languageEntries = {
                [`${trader}_${questNumber} name`]: questName,
                [`${trader}_${questNumber} description`]: document.getElementById('quest-desc-lang').value,
                [`${trader}_${questNumber} startedMessageText`]: document.getElementById('quest-start-msg-lang').value,
                [`${trader}_${questNumber} successMessageText`]: document.getElementById('quest-success-msg-lang').value,
                [`${trader}_${questNumber} failMessageText`]: document.getElementById('quest-fail-msg-lang').value,
                [`${trader}_${questNumber} acceptPlayerMessage`]: document.getElementById('quest-accept-msg-lang').value,
                [`${trader}_${questNumber} declinePlayerMessage`]: document.getElementById('quest-decline-msg-lang').value,
                [`${trader}_${questNumber} completePlayerMessage`]: document.getElementById('quest-complete-msg-lang').value,
                [`${trader}_${questNumber} changeQuestMessageText`]: document.getElementById('quest-change-msg-lang').value
            };

            const languageContainer = document.getElementById('dynamic-lang-variables-container');
            const dynamicLangFields = languageContainer.querySelectorAll('.dynamic-lang-entry input[type="text"]');
            dynamicLangFields.forEach(input => {
                const fieldId = input.id;
                languageEntries[fieldId] = input.value || '';
            });

            // Quest Assortments
            const assortments = {};
            rewards.forEach(reward => {
                if (reward.type === 'AssortmentUnlock') {
                    assortments[reward.target] = questNameID;
                }
            });

            const quest = {
                [questNameID]: {
                    QuestName: questName,
                    _id: questNameID,
                    traderId: trader,
                    type: questType,
                    description: `${trader}_${questNumber} description`,
                    startedMessageText: `${trader}_${questNumber} startedMessageText`,
                    successMessageText: `${trader}_${questNumber} successMessageText`,
                    failMessageText: `${trader}_${questNumber} failMessageText`,
                    acceptPlayerMessage: `${trader}_${questNumber} acceptPlayerMessage`,
                    declinePlayerMessage: `${trader}_${questNumber} declinePlayerMessage`,
                    completePlayerMessage: `${trader}_${questNumber} completePlayerMessage`,
                    changeQuestMessageText: `${trader}_${questNumber} changeQuestMessageText`,
                    conditions: {
                        AvailableForStart: availableForStartConditions,
                        AvailableForFinish: conditions,
                        Fail: []
                    },
                    rewards: {
                        Success: rewards,
                        Fail: [],
                        Started: []
                    }
                }
            };

            // Output Display
            document.getElementById('output').textContent = JSON.stringify(quest, null, 2);
            document.getElementById('language-output').textContent = JSON.stringify(languageEntries, null, 2);
            document.getElementById('assortments-output').textContent = JSON.stringify(assortments, null, 2);
            document.getElementById('quest-output-section').style.display = 'block';
        }

    </script>
</body>
</html>
