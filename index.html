<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haven VCQL Helper</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
    <h1>Haven Quest Helper</h1>
    <h4>Made for Virtual's Custom Quest Loader - SPT Mod</h4>
    
    <div id="top-right-box" style="position: absolute; top: 20px; right: 20px; border: 1px solid #ccc; padding: 10px;  border-radius: 8px;">
        <h3><strong>Website Settings</strong></h3>
        <div id="language-container" style="text-align: left;">
            <label for="language-select">Item Names Language: </label>
            <select id="language-select" onchange="loadLanguage(this.value)">
                <option value="en.json" selected>English</option>
                <option value="cz.json">Czech</option>
                <option value="fr.json">French</option>
                <option value="ge.json">German</option>
                <option value="hu.json">Hungarian</option>
                <option value="it.json">Italian</option>
                <option value="jp.json">Japanese</option>
                <option value="kr.json">Korean</option>
                <option value="pl.json">Polish</option>
                <option value="po.json">Portuguese</option>
                <option value="ro.json">Romanian</option>
                <option value="ru.json">Russian</option>
                <option value="sk.json">Slovak</option>
                <option value="ch.json">Chinese</option>
                <option value="es.json">Spanish</option>
                <option value="es-mx.json">Mexican Spanish</option>
                <option value="tu.json">Turkish</option>
            </select>
        </div>
        
        <button id="toggleUsefulInfoBtn" onclick="toggleUsefulInfo()" style="margin-top: 10px; width: 100%;">Show Useful Info</button>
        <button id="toggleHowToUseBtn" onclick="toggleHowToUse()" style="margin-top: 10px; width: 100%;">Show How to Use</button>
        <button id="reloadButton" onclick="reloadPage()" style="margin-top: 10px;">Reset Quest Info</button>
    </div>

    <section id="useful-info" style="display: none; position: relative;">
        <strong>Useful info:</strong>
        <ul>
            <li><a href="https://hub.sp-tarkov.com/doc/entry/7-resources-item-properties-list/" target="_blank" style="color: #4646ff; text-decoration: underline;">Item Resource List</a></li>
            <li><a href="https://hub.sp-tarkov.com/doc/entry/57-resources-quest-values-reference-tool/" target="_blank" style="color: #4646ff; text-decoration: underline;">Quest Values Reference Tool</a></li>
            <li><a href="https://raw.githubusercontent.com/RuKira/SPT-AllInOne/refs/heads/main/SPT-AllInOne/Data/quests.json" target="_blank" style="color: #4646ff; text-decoration: underline;">EFT Default Quest References</a></li>
        </ul>
        <strong>Zone ID List for Kills condition</strong>
        <ul>
            <li><a href="https://github.com/guillaumearm/SPT_CustomQuests/blob/master/docs/ALL_ZONES.md" target="_blank" style="color: #4646ff; text-decoration: underline;">Zones IDs</a></li>
            <li><a href="https://github.com/guillaumearm/SPT_CustomQuests/blob/master/docs/ALL_PLACES.md" target="_blank" style="color: #4646ff; text-decoration: underline;">Places IDs</a></li>
        </ul>
        <h4>Version 0.0.1</h4>
    </section>
    
    <section id="how-to-use" style="display: none; position: relative;">
        <strong>How to use:</strong>
        <ul>
            <li>Quest Name is the name of the quest (it converts it into an id for you too)</li>
            <li>Trader Name is the name of the trader that gives the quest</li>
            <li>Conditions are the requirements for the quest
                <ul>
                    <li>Find Item: Find an item in raid
                        <ul>
                            <li>You can add or remove multiple items to find.</li>
                            <li>Target Items: The item(s) that need to be found</li>
                            <li>Value: The quantity of the item(s) that need to be found</li>
                            <li>Only Found In Raid: Whether the item(s) need to be found in raid</li>
                        </ul>
                    </li>
                    <li>Handover Item: Handover an item
                        <ul>
                            <li>This is the same as Find Item but instead it's handing them over to the trader.</li>
                        </ul>
                    </li>
                    <li>Kills: Kill a certain amount of scavs or PMCs
                        <ul>
                            <li>Zone ID: The zone ID where the kills need to be done</li>
                            <li>Location: The location where the kills need to be done</li>
                            <li>Target: The type of target to kill (Scavs, PMCs, etc.)</li>
                            <li>Kills Required: The number of kills required</li>
                            <li>Distance Comparison: The distance for the kills for example less than 50 meters.
                                <ul>
                                    <li>Right > means greater than or equal to</li>
                                    <li>Left < means less than or equal to</li>
                                </ul>
                            </li>
                            <li>Time of Day From: for example 6am would be 6</li>
                            <li>Time of Day To: for example 6pm would be 18</li>
                            <li>Reset on Session End: Whether the kills reset on session end</li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
    </section>
    
    <!-- Quest Input Section -->
    <h2>Quest Creation</h2>
    <section>
        <label for="quest-name">Quest Name:</label>
        <input type="text" id="quest-name" placeholder="Enter quest name" required>

        <label for="trader-name">Quest Trader Name:</label>
        <input type="text" id="trader-name" placeholder="Enter Trader name" required>

        <label for="quest-type">Quest Type:</label>
        <select id="quest-type">
            <option value="Completion">Completion</option>
            <option value="PickUp">Pick Up</option>
            <option value="Elimination">Elimination</option>
        </select>

        <h3>Conditions</h3>
        <button onclick="addCondition()" style="margin-bottom: 10px;">Add Condition</button>
        <div id="conditions-container" class="dynamic-fields"></div>

        <h3>Rewards</h3>
        <button onclick="addReward()" style="margin-bottom: 10px;">Add Reward</button>
        <div id="rewards-container" class="dynamic-fields"></div>

        <button onclick="generateQuest()" style="margin-top: 10px;">Generate Quest JSON</button>
    </section>
    
    <section id="quest-output-section" style="display: none; position: relative;">
        <h2>Quest JSON Output</h2>
        
        <div style="position: relative;">
            <button id="copyQuestButton" onclick="copyQuest()" style="position: absolute; right: 10px; top: 30px; padding: 5px 10px; width: auto;">
                Copy Quest to Clipboard
            </button>
        </div>
        <pre id="output" style="margin-top: 40px; padding: 10px;">Generated quest JSON will appear here...</pre>
    
        <div style="margin-top: 40px; padding: 15px; border: 1px solid #444; border-radius: 5px; background-color: #1e1e1e; color: #e0e0e0; position: relative;">
            <h3>Quest Language Variables</h3>
            <button id="copyLangButton" onclick="copyLanguageEntries()" style="position: absolute; right: 10px; top: 10px; padding: 5px 10px; width: auto;">
                Copy Language Variables to Clipboard
            </button>
            <pre id="language-output" style="margin-top: 20px; padding: 10px;">Language variables will appear here...</pre>
        </div>
    </section>

    <script>
        let items = [];
        let languageData = {};

        document.addEventListener('DOMContentLoaded', () => {
            loadLanguage('en.json');
            loadItems();
        });

        function reloadPage() {
            const currentUrl = window.location.href.split('?')[0];
            window.location.href = `${currentUrl}?t=${new Date().getTime()}`;
        }

        async function loadLanguage(languageFile) {
            try {
                const response = await fetch(`lang/${languageFile}`);
                if (!response.ok) throw new Error(`Error loading language file: ${response.status}`);
                
                languageData = await response.json();
                
                mapLanguageToItems();
                
                const targetItemDivs = document.querySelectorAll('.target-item .dropdown-item');
                targetItemDivs.forEach(itemDiv => {
                    const itemId = itemDiv.getAttribute('data-value');
                    const item = items.find(i => i._id === itemId);
                    if (item) {
                        itemDiv.textContent = item.displayName;
                    }
                });
            } catch (error) {
                console.error("Failed to load language:", error);
            }
        }

        async function loadItems() {
            if (!window.itemsLoaded) {
                try {
                    const response = await fetch('items.json');
                    if (!response.ok) throw new Error(`Error loading items: ${response.status}`);
                    const allItems = await response.json();

                    items = Object.values(allItems).filter(item => item._id && item._props);

                    mapLanguageToItems();
                    items.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''));

                    window.itemsLoaded = true;
                } catch (error) {
                    console.error("Failed to load items:", error);
                    window.itemsLoaded = false;
                }
            }
        }

        function mapLanguageToItems() {
            if (!languageData || !items) return;

            items.forEach(item => {
                const itemId = item._id;
                const shortNameKey = `${itemId} ShortName`;
                const nameKey = `${itemId} Name`;

                item.displayName = languageData[nameKey] || languageData[shortNameKey] || item._props.Name;
            });

            items.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''));
        }

        function addCondition() {
            const container = document.getElementById('conditions-container');
            const conditionDiv = document.createElement('div');
            conditionDiv.classList.add("condition");

            conditionDiv.innerHTML = `
                <label>Condition Type:
                    <select onchange="updateConditionFields(this)">
                        <option value="FindItem">Find Item</option>
                        <option value="HandoverItem">Handover Item</option>
                        <option value="Kills">Kills</option>
                    </select>
                </label>
                <div class="condition-details"></div>
                <div class="target-items-container"></div> <!-- Separate container for target items -->
            `;
            container.appendChild(conditionDiv);
            updateConditionFields(conditionDiv.querySelector('select'));
        }

        function removeCondition(button) {
            button.closest('.condition').remove();
        }

        async function updateConditionFields(selectElement) {
            if (!window.itemsLoaded) {
                await loadItems();
                if (!window.itemsLoaded) return;
            }

            const conditionDetails = selectElement.closest('.condition').querySelector('.condition-details');
            conditionDetails.innerHTML = '';

            if (selectElement.value === 'FindItem' || selectElement.value === 'HandoverItem') {
                conditionDetails.innerHTML = `
                    <label>Target Items:</label>
                    <div class="target-items-container"></div>
                    <button type="button" onclick="addTargetItem()" style="margin-top: 10px; width: auto;">Add New Item</button>
                    <label>Value:
                        <input type="number" placeholder="Quantity" required value="1">
                    </label>
                    <label>Only Found In Raid:
                        <input type="checkbox">
                    </label>
                    <div style="margin-top: 10px; display: inline-block;">
                        <button class="remove-btn" onclick="removeCondition(this)" style="width: auto; padding: 5px 10px;">Remove Condition</button>
                    </div>
                `;
            } else if (selectElement.value === 'Kills') {
                conditionDetails.innerHTML = `
                    <label>Zone ID (e.g., huntsman_005_2) 
                        <a href="https://github.com/guillaumearm/SPT_CustomQuests/blob/master/docs/ALL_ZONES.md" target="_blank" style="color: #4646ff; text-decoration: underline;">Click Here for All Zones</a>:
                        <input type="text" placeholder="Enter zone ID" required>
                    </label>
                    <label>Location:
                        <select class="location-dropdown" required>
                            <option value="any" selected>Any</option>
                            <option value="55f2d3fd4bdc2d5f408b4567">Factory Day</option>
                            <option value="59fc81d786f774390775787e">Factory Night</option>
                            <option value="56f40101d2720b2a4d8b45d6">Customs</option>
                            <option value="5704e3c2d2720bac5b8b4567">Woods</option>
                            <option value="5704e4dad2720bb55b8b4567">Lighthouse</option>
                            <option value="5704e554d2720bac5b8b456e">Shoreline</option>
                            <option value="5704e5fad2720bc05b8b4567">Reserve</option>
                            <option value="5714dbc024597771384a510d">Interchange</option>
                            <option value="5b0fc42d86f7744a585f9105">The Lab</option>
                            <option value="5714dc692459777137212e12">Streets</option>
                            <option value="653e6760052c01c1c805532f">Ground Zero</option>
                        </select>
                    </label>
                    <label>Target:
                        <select required>
                            <option value="Savage">Scavs</option>
                            <option value="AnyPmc">PMCs</option>
                            <option value="Usec">Usec</option>
                            <option value="Bear">Bear</option>
                            <option value="Any" selected>Any</option>
                        </select>
                    </label>
                    <label>Kills Required:
                        <input type="number" placeholder="Number of kills" required value="1">
                    </label>
                    <label>Distance Comparison:
                        <select>
                            <option value=">=">&ge;</option>
                            <option value="<=">&le;</option>
                        </select>
                        <input type="number" placeholder="Distance in meters" required value="0">
                    </label>
                    <label>Time of Day From (0-24):
                        <input type="number" min="0" max="24" value="0" required>
                    </label>
                    <label>Time of Day To (0-24):
                        <input type="number" min="0" max="24" value="0" required>
                    </label>
                    <label>Reset on Session End:
                        <input type="checkbox">
                    </label>
                    <div style="margin-top: 10px; display: inline-block;">
                        <button class="remove-btn" onclick="removeCondition(this)" style="width: auto; padding: 5px 10px;">Remove Condition</button>
                    </div>
                `;
            }
        }

        function addTargetItem() {
            const conditionDiv = event.target.closest('.condition');
            const container = conditionDiv.querySelector('.target-items-container');
            const targetDiv = document.createElement('div');
            targetDiv.classList.add('target-item');

            targetDiv.innerHTML = `
                <div class="custom-dropdown">
                    <input type="text" class="dropdown-search" placeholder="Search items..." oninput="filterDropdown(this)">
                    <div class="dropdown-menu">
                        ${items.map(item =>
                            `<div class="dropdown-item" data-value="${item._id}" onclick="selectDropdownItem(this)">
                                ${item.displayName}
                            </div>`
                        ).join('')}
                    </div>
                </div>
                <button type="button" onclick="removeTargetItem(this)" style="margin-top: 10px;">Remove</button>
            `;

            container.appendChild(targetDiv);
        }

        function removeTargetItem(button) {
            button.closest('.target-item').remove();
        }

        function filterDropdown(input) {
            const searchTerm = input.value.toLowerCase();
            const dropdownMenu = input.nextElementSibling;

            if (searchTerm) {
                dropdownMenu.classList.add('show');
            } else {
                dropdownMenu.classList.remove('show');
            }

            Array.from(dropdownMenu.children).forEach(item => {
                const itemName = item.textContent.toLowerCase();
                item.style.display = itemName.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function selectDropdownItem(item) {
            const dropdown = item.closest('.custom-dropdown');
            const selectedItem = dropdown.querySelector('.dropdown-search');
            selectedItem.value = item.textContent.trim();
            selectedItem.dataset.selectedValue = item.dataset.value;
            dropdown.querySelector('.dropdown-menu').classList.remove('show');
        }

        function addReward() {
            const container = document.getElementById('rewards-container');
            const rewardDiv = document.createElement('div');
            rewardDiv.classList.add("reward");

            rewardDiv.innerHTML = `
                <label>Reward Type:
                    <select onchange="updateRewardFields(this)">
                        <option value="Experience">Experience</option>
                        <option value="TraderStanding">Trader Standing</option>
                        <option value="Item">Item</option>
                        <option value="AssortmentUnlock">AssortmentUnlock</option>
                    </select>
                </label>
                <div class="reward-details"></div>
                <button onclick="removeReward(this)" style="margin-top: 10px; width: auto;">Remove Reward</button>
            `;
            
            container.appendChild(rewardDiv);
            updateRewardFields(rewardDiv.querySelector('select'));
        }

        function updateRewardFields(selectElement) {
            const rewardDetails = selectElement.closest('.reward').querySelector('.reward-details');
            rewardDetails.innerHTML = ''; // Clear previous content

            if (selectElement.value === 'AssortmentUnlock') {
                rewardDetails.innerHTML = `
                    <label>Reward ID:
                        <input type="text" class="assortment-id" placeholder="Enter reward _id" required>
                    </label>
                    <label>Loyalty Level:
                        <select class="loyalty-level" required>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </label>
                    <label>Main Item:
                        <div class="custom-dropdown">
                            <input type="text" class="dropdown-search main-item" placeholder="Search items..." oninput="filterDropdown(this)">
                            <div class="dropdown-menu">
                                ${items.map(item =>
                                    `<div class="dropdown-item" data-value="${item._id}" onclick="selectRewardItem(this)">
                                        ${item.displayName}
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    </label>
                    <div id="attachment-container"></div>
                    <button type="button" onclick="addAttachment()" style="margin-top: 10px;">Add Attachment</button>
                `;
            } else {
                rewardDetails.innerHTML = `
                    <label>Reward Value:
                        <input type="number" placeholder="Value" required>
                    </label>
                `;
            }
        }

        function addAttachment() {
            const attachmentContainer = document.getElementById('attachment-container');
            const attachmentDiv = document.createElement('div');
            attachmentDiv.classList.add('attachment');

            attachmentDiv.innerHTML = `
                <label>Attachment ID:
                    <input type="text" class="attachment-id" placeholder="Enter attachment _id" required>
                </label>
                <label>Template ID (_tpl):
                    <div class="custom-dropdown">
                        <input type="text" class="dropdown-search attachment-tpl" placeholder="Search items..." oninput="filterDropdown(this)">
                        <div class="dropdown-menu">
                            ${items.map(item =>
                                `<div class="dropdown-item" data-value="${item._id}" onclick="selectRewardItem(this)">
                                    ${item.displayName}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                </label>
                <label>Slot ID:
                    <select class="attachment-slot" required>
                        <option value="">Select slot</option>
                        <option value="mod_pistol_grip">mod_pistol_grip</option>
                        <option value="mod_magazine">mod_magazine</option>
                        <option value="mod_reciever">mod_reciever</option>
                        <option value="mod_barrel">mod_barrel</option>
                        <option value="mod_muzzle">mod_muzzle</option>
                        <option value="mod_gas_block">mod_gas_block</option>
                        <option value="mod_handguard">mod_handguard</option>
                        <option value="mod_sight_front">mod_sight_front</option>
                        <option value="mod_sight_rear">mod_sight_rear</option>
                        <option value="mod_stock_001">mod_stock_001</option>
                        <option value="mod_stock_000">mod_stock_000</option>
                        <option value="mod_charge">mod_charge</option>
                    </select>
                </label>
                <label>
                    <input type="checkbox" class="is-weapon" onclick="toggleWeaponAttributes(this)"> Is a Weapon
                </label>
                <div class="weapon-attributes" style="display: none;">
                    <label>Fire Mode:
                        <select class="weapon-firemode">
                            <option value="single" selected>Single</option>
                            <option value="auto">Auto</option>
                        </select>
                    </label>
                    <label>Foldable:
                        <input type="checkbox" class="weapon-foldable">
                    </label>
                    <label>Durability:
                        <input type="number" class="weapon-durability" placeholder="Current durability" value="100">
                    </label>
                    <label>Max Durability:
                        <input type="number" class="weapon-max-durability" placeholder="Max durability" value="100">
                    </label>
                    <label>Stack Objects Count:
                        <input type="number" class="stack-objects-count" placeholder="Stack count" value="1">
                    </label>
                </div>
                <button type="button" onclick="removeAttachment(this)" style="margin-top: 10px;">Remove Attachment</button>
            `;

            attachmentContainer.appendChild(attachmentDiv);
        }

        function toggleWeaponAttributes(checkbox) {
            const weaponAttributes = checkbox.closest('.attachment').querySelector('.weapon-attributes');
            weaponAttributes.style.display = checkbox.checked ? 'block' : 'none';
        }

        function removeAttachment(button) {
            button.closest('.attachment').remove();
        }


        function selectRewardItem(item) {
            const dropdown = item.closest('.custom-dropdown');
            const selectedItem = dropdown.querySelector('.dropdown-search');
            selectedItem.value = item.textContent.trim();
            selectedItem.dataset.selectedValue = item.dataset.value;
            dropdown.querySelector('.dropdown-menu').classList.remove('show');
        }

        function removeReward(button) {
            button.closest('.reward').remove();
        }

        function copyQuest() {
            const outputText = document.getElementById('output').textContent;
            navigator.clipboard.writeText(outputText).then(() => {
                const button = document.getElementById('copyQuestButton');
                button.innerText = "Copied to Clipboard";
                setTimeout(() => button.innerText = "Copy Quest to Clipboard", 3000);
            }).catch(err => {
                console.error("Failed to copy quest:", err);
            });
        }

        function copyLanguageEntries() {
            const languageOutputText = document.getElementById('language-output').textContent; 
            if (!languageOutputText) {
                console.error("No language variables to copy.");
                return; 
            }
            navigator.clipboard.writeText(languageOutputText).then(() => {
                const button = document.getElementById('copyLangButton');
                button.innerText = "Copied to Clipboard";
                setTimeout(() => button.innerText = "Copy Language Variables to Clipboard", 3000);
            }).catch(err => {
                console.error("Failed to copy language variables:", err);
            });
        }


        let usefulInfoVisible = false;

        function toggleUsefulInfo() {
            const usefulInfoSection = document.getElementById('useful-info');
            usefulInfoVisible = !usefulInfoVisible;

            if (usefulInfoVisible) {
                usefulInfoSection.style.display = 'block';
                document.getElementById('toggleUsefulInfoBtn').innerText = 'Hide Useful Info';
            } else {
                usefulInfoSection.style.display = 'none';
                document.getElementById('toggleUsefulInfoBtn').innerText = 'Show Useful Info';
            }
        }

        let howToUseVisible = false;

        function toggleHowToUse() {
            const howToUseSection = document.getElementById('how-to-use');
            howToUseVisible = !howToUseVisible;

            if (howToUseVisible) {
                howToUseSection.style.display = 'block';
                document.getElementById('toggleHowToUseBtn').innerText = 'Hide How to Use';
            } else {
                howToUseSection.style.display = 'none';
                document.getElementById('toggleHowToUseBtn').innerText = 'Show How to Use';
            }
        }

        function generateQuest() {
            const questName = document.getElementById('quest-name').value;
            const questNameID = questName.replace(/\s+/g, '_');
            const trader = document.getElementById('trader-name').value;
            const questType = document.getElementById('quest-type').value;

            const conditions = Array.from(document.querySelectorAll('#conditions-container > .condition')).map((div, index) => {
                const conditionType = div.querySelector('select').value;

                if (conditionType === 'Kills') {
                    const locationId = div.querySelector('.location-dropdown').value;
                    const timeFrom = div.querySelector('input[type=number]:nth-of-type(1)').value;
                    const timeTo = div.querySelector('input[type=number]:nth-of-type(2)').value;
                    return [
                        {
                            conditionType: "InZone",
                            dynamicLocale: false,
                            id: `${trader}_0 zoneCondition`,
                            zoneIds: [div.querySelector('input[type=text]').value]
                        },
                        {
                            bodyPart: [],
                            compareMethod: div.querySelector('select:nth-of-type(2)').value,
                            conditionType: "Kills",
                            daytime: { from: parseInt(timeFrom), to: parseInt(timeTo) },
                            distance: { compareMethod: div.querySelector('select:nth-of-type(2)').value, value: parseInt(div.querySelector('input[type=number]').value, 10) },
                            dynamicLocale: false,
                            enemyEquipmentExclusive: [],
                            enemyEquipmentInclusive: [],
                            enemyHealthEffects: [],
                            id: `${trader}_0 Obj_${index + 1}`,
                            resetOnSessionEnd: div.querySelector('input[type=checkbox]').checked,
                            savageRole: [],
                            target: div.querySelector('input[type=text]:nth-of-type(2)').value,
                            value: parseInt(div.querySelector('input[type=number]').value, 10),
                            location: locationId,
                            weapon: [],
                            weaponCaliber: [],
                            weaponModsExclusive: [],
                            weaponModsInclusive: []
                        }
                    ];
                } else {
                    const targetItems = Array.from(div.querySelectorAll('.dropdown-search')).map(input => input.dataset.selectedValue);
                    return {
                        conditionType: conditionType,
                        countInRaid: false,
                        dogtagLevel: 0,
                        dynamicLocale: false,
                        globalQuestCounterId: "",
                        id: `${trader}_0 Obj_${index + 1}`,
                        index: index,
                        isEncoded: false,
                        maxDurability: 100,
                        minDurability: 0,
                        onlyFoundInRaid: true,
                        parentId: "",
                        target: targetItems,
                        value: parseInt(div.querySelector('input[type=number]').value, 10),
                        visibilityConditions: []
                    };
                }
            }).flat();

            const rewards = Array.from(document.querySelectorAll('#rewards-container > .reward')).map((div, index) => {
                const rewardType = div.querySelector('select').value;

                if (rewardType === 'AssortmentUnlock') {
                    const rewardId = div.querySelector('.assortment-id').value;
                    const loyaltyLevel = parseInt(div.querySelector('.loyalty-level').value);
                    const mainItemId = div.querySelector('.main-item').dataset.selectedValue;

                    // Collect attachments
                    const attachments = Array.from(div.querySelectorAll('.attachment')).map(attachmentDiv => {
                        const attachment = {
                            _id: attachmentDiv.querySelector('.attachment-id').value,
                            _tpl: attachmentDiv.querySelector('.attachment-tpl').dataset.selectedValue,
                            parentId: attachmentDiv.querySelector('.attachment-parent').value || null,
                            slotId: attachmentDiv.querySelector('.attachment-slot').value || null,
                        };

                        // If it's marked as a weapon, add additional properties
                        if (attachmentDiv.querySelector('.is-weapon').checked) {
                            attachment.upd = {
                                FireMode: { FireMode: attachmentDiv.querySelector('.weapon-firemode').value },
                                Foldable: { Folded: !attachmentDiv.querySelector('.weapon-foldable').checked },
                                Repairable: {
                                    Durability: parseInt(attachmentDiv.querySelector('.weapon-durability').value),
                                    MaxDurability: parseInt(attachmentDiv.querySelector('.weapon-max-durability').value)
                                },
                                StackObjectsCount: parseInt(attachmentDiv.querySelector('.stack-objects-count').value)
                            };
                        }

                        return attachment;
                    });

                    // Main item structure
                    const items = [
                        {
                            _id: rewardId,
                            _tpl: mainItemId,
                        },
                        ...attachments
                    ];

                    return {
                        id: `${trader}_0 reward_${index}`,
                        index: index,
                        items: items,
                        loyaltyLevel: loyaltyLevel,
                        target: rewardId,
                        traderId: trader,
                        type: 'AssortmentUnlock'
                    };
                } else {
                    return {
                        id: `${trader}_0 reward_${index}`,
                        index: index,
                        type: rewardType,
                        value: div.querySelector('input[type=number]').value
                    };
                }
            });

            const quest = {
                [questNameID]: {
                    QuestName: questName,
                    _id: questNameID,
                    acceptPlayerMessage: `${trader}_0 acceptPlayerMessage`,
                    canShowNotificationsInGame: true,
                    changeQuestMessageText: `${trader}_0 changeQuestMessageText`,
                    completePlayerMessage: `${trader}_0 completePlayerMessage`,
                    conditions: {
                        AvailableForFinish: conditions,
                        AvailableForStart: [],
                        Fail: []
                    },
                    declinePlayerMessage: `${trader}_0 declinePlayerMessage`,
                    description: `${trader}_0 description`,
                    failMessageText: `${trader}_0 failMessageText`,
                    image: `/files/quest/icon/${trader}_0.png`,
                    instantComplete: false,
                    isKey: false,
                    location: "any",
                    name: `${trader}_0 name`,
                    note: `${trader}_0 note`,
                    restartable: false,
                    rewards: {
                        Fail: [],
                        Started: [],
                        Success: rewards
                    },
                    secretQuest: false,
                    side: "Pmc",
                    startedMessageText: `${trader}_0 startedMessageText`,
                    successMessageText: `${trader}_0 successMessageText`,
                    traderId: trader,
                    type: questType
                }
            };

            // Prepare language entries
            let languageEntries = {};
            languageEntries[`${trader}_0 name`] = ""; 
            languageEntries[`${trader}_0 description`] = ""; 
            languageEntries[`${trader}_0 startedMessageText`] = ""; 
            languageEntries[`${trader}_0 successMessageText`] = ""; 
            languageEntries[`${trader}_0 failMessageText`] = ""; 
            languageEntries[`${trader}_0 acceptPlayerMessage`] = ""; 
            languageEntries[`${trader}_0 declinePlayerMessage`] = ""; 
            languageEntries[`${trader}_0 completePlayerMessage`] = ""; 
            languageEntries[`${trader}_0 changeQuestMessageText`] = ""; 

            // Loop through conditions to add language entries
            conditions.forEach((condition) => {
                if (typeof condition === "object" && condition.id) {
                    languageEntries[condition.id] = ""; 
                }
            });

            // Loop through rewards to add language entries
            rewards.forEach(reward => {
                languageEntries[reward.id] = ""; 
            });

            // Display the quest
            document.getElementById('output').textContent = JSON.stringify(quest, null, 2);
            
            // Display the language variables
            const languageEntriesOutput = document.getElementById('language-output');
            languageEntriesOutput.textContent = JSON.stringify(languageEntries, null, 2);

            // Show the quest output section
            document.getElementById('quest-output-section').style.display = 'block';
        }

    </script>
</body>
</html>
